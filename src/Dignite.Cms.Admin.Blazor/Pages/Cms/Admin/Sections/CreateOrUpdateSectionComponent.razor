@using Dignite.Cms.Admin.Sections
@using Dignite.Cms.Localization
@using Dignite.Cms.Sections;
@using System.Threading
@using Volo.Abp.BlazoriseUI.Components.ObjectExtending
@using Volo.Abp.Localization;
@inject AbpBlazorMessageLocalizerHelper<CmsResource> LH
@inject ISectionAdminAppService _sectionAdminAppService;
@inherits AbpComponentBase

<Validation MessageLocalizer="@LH.Localize">
    <Field>
        <FieldLabel>@L["DisplayName"]</FieldLabel>
            <TextEdit @bind-Text="Entity.DisplayName" Blur="DisplayNameTextboxBlur" Autofocus="true">
            <Feedback>
                <ValidationError />
            </Feedback>
        </TextEdit>
    </Field>
</Validation>
    <Validation MessageLocalizer="@LH.Localize" AsyncValidator="@NameExistsValidatorAsync">
    <Field>
        <FieldLabel>@L["Name"]</FieldLabel>
        <TextEdit @bind-Text="Entity.Name">
            <Feedback>
                <ValidationError />
            </Feedback>
        </TextEdit>
    </Field>
</Validation>
<Validation MessageLocalizer="@LH.Localize">
    <Field>
        <FieldLabel>@L["SectionType"]</FieldLabel>
        <RadioGroup TValue="SectionType" Name="SectionType" @bind-CheckedValue="Entity.Type">
            @foreach(var item in SectionTypes)
            {
            <Radio TValue="SectionType" Value="@item">@L[item.ToLocalizationKey()]</Radio>
            }
        </RadioGroup>
    </Field>
</Validation>
<Validation MessageLocalizer="@LH.Localize">
    <Field>
        <FieldLabel>@L["Route"]</FieldLabel>
        <TextEdit @bind-Text="Entity.Route">
            <Feedback>
                <ValidationError />
            </Feedback>
        </TextEdit>
    </Field>
</Validation>
<Validation MessageLocalizer="@LH.Localize">
    <Field>
        <FieldLabel>@L["Template"]</FieldLabel>
        <TextEdit @bind-Text="Entity.Template">
            <Feedback>
                <ValidationError />
            </Feedback>
        </TextEdit>
    </Field>
</Validation>
<Field>
    <Check TValue="bool" @bind-Checked="Entity.IsDefault">@L["IsDefault"]</Check>
</Field>
<Field>
    <Check TValue="bool" @bind-Checked="Entity.IsActive">@L["IsActive"]</Check>
</Field>


    @code {
    [Parameter] public CreateOrUpdateSectionInputBase Entity { get; set; }

    [Parameter] public Guid? SiteId { get; set; }

    protected IReadOnlyList<SectionType> SectionTypes { get; set; }

    //Will not change again after assignment, used to verify that the site name already exists
    private string sectionNameForValidation;

    public CreateOrUpdateSectionComponent()
    {
        LocalizationResource = typeof(CmsResource);
        SectionTypes = Enum.GetValues(typeof(SectionType))
                            .Cast<SectionType>()
                            .ToList();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        sectionNameForValidation = Entity.Name;
    }

    private async Task NameExistsValidatorAsync(ValidatorEventArgs e, CancellationToken cancellationToken)
    {
        cancellationToken.ThrowIfCancellationRequested();
        var name = Convert.ToString(e.Value);
        if (SiteId.HasValue && !name.IsNullOrEmpty())
        {
            if (!name.Equals(sectionNameForValidation, StringComparison.InvariantCultureIgnoreCase))
            {
                e.Status = await _sectionAdminAppService.NameExistsAsync(new SectionNameExistsInput(SiteId.Value,name))
                    ? ValidationStatus.Error
                    : ValidationStatus.Success;

                e.ErrorText = L["SectionName{0}AlreadyExist", name];
            }
        }
        else
        {
            e.Status = ValidationStatus.Error;
        }
    }

    void DisplayNameTextboxBlur()
    {
        if (!Entity.DisplayName.IsNullOrEmpty() && Entity.Name.IsNullOrEmpty())
        {
            Entity.Name = SlugNormalizer.Normalize(Entity.DisplayName);

            //
            if (Entity.Type == SectionType.Single)
            {
                Entity.Route = Entity.Name + "/{slug}";
                Entity.Template = Entity.Route+"/Index";
            }
            else
            {
                Entity.Route = Entity.Name + "/{slug}";
                Entity.Template = Entity.Route+"/Entry";
            }
        }
    }
}